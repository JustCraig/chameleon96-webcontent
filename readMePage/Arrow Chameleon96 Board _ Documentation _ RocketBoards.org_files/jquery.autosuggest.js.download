(function(e){"use strict";e.widget("solr.autosuggest",e.ui.autocomplete,{options:{thumbnailBase:null,delay:500,minLength:3,extraParams:{limit:3,fields:"name,web,topic,container_title,title,type,thumbnail,url,field_Telephone_s,field_Phone_s,field_Mobile_s"},position:{my:"right top",at:"right+5 bottom+11",collision:"none"},locales:{persons:"Persons",topics:"Topics",attachments:"Attachments",loading:"Loading ...",more:"... more"},templates:{persons:"<li class='ui-autosuggest-item {{:group}} {{:isFirst}} {{:isLast}}'>{{:header}}"+"{{if phoneNumber}}<a class='ui-autosuggest-phone-number' href='sip:{{:phoneNumber}}'></a>{{/if}}"+"<a href='{{:url}}' class='ui-autosuggest-link'>"+"<table class='foswikiNullTable'><tr>"+"<th><div><img class='thumbnail' width='48' alt='{{:name}}' src='{{:thumbnail}}' /></div></th>"+"<td>{{:title}}<div class='foswikiGrayText'>{{:phoneNumber}}</div></td>"+"</tr></table></a>"+"</li>{{{:footer}}","default":"<li class='ui-autosuggest-item {{:group}} {{:isFirst}} {{:isLast}}'>{{:header}}"+"<a href='{{:url}}' class='ui-autosuggest-link'>"+"<table class='foswikiNullTable'><tr>"+"<th><div><img class='thumbnail' width='48' alt='{{:name}}' src='{{:thumbnail}}' /></div></th>"+"<td>{{:title}}<div class='foswikiGrayText'>{{:container_title}}</div></td>"+"</tr></table>"+"</a></li>{{:footer}}",header:"<div class='ui-autosuggest-title {{:group}}'>{{:title}}</div>",footer:"<li class='ui-autosuggest-item ui-autosuggest-more'><a class='ui-autosuggest-link' href='{{:moreUrl}}'>{{:title}}</a></li>"},focus:function(){return false},select:function(t,i){if(t.keyCode==13||e.browser.msie){window.location.href=i.item.url}return false},cache:true,source:null,menuClass:null},_init:function(){var e=this,t=e.menu.element;e.options.thumbnailBase=foswiki.getPreference("SCRIPTURL")+"/rest/ImagePlugin/resize?size=48&crop=on";t.addClass("ui-autosuggest").removeClass("ui-autocomplete");if(e.options.menuClass){t.addClass(e.options.menuClass)}e.templates={}},_initSource:function(){var t=this;t.cache={};t.options.source=t.options.source||foswiki.getPreference("SCRIPTURL")+"/rest/SolrPlugin/autosuggest";t.source=function(i,s){var o=i.term.replace(/(^\s+)|(\s+$)/g,""),a=o;i.term=o;if(typeof t.options.extraParams!="undefined"){e.each(t.options.extraParams,function(e,s){var o=typeof s==="function"?s(t):s;i[e]=o;a+=";"+e+"="+o})}i.topic=foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC");if(t.options.cache&&a in t.cache){s(t.cache[a]);return}if(t.xhr){t.xhr.abort()}t.xhr=e.ajax({url:t.options.source,data:i,dataType:"json",success:function(e,i,o){if(t.options.cache){t.cache[a]=e}if(o===t.xhr){s(e)}},error:function(e){s([])}})}},_getTemplate:function(t){var i=this,s=i.templates[t],o;if(typeof s==="undefined"){o=i.options.templates[t];if(typeof o!=="undefined"){s=i.templates[t]=e.templates(o)}}return s},_renderMenu:function(t,i){var s=this,o=s.element.val();e.each(i,function(i,o){var a,r,n=o.docs.length;if(!n){return}a=s._getTemplate("header").render({group:o.group,title:s.options.locales[o.group]||o.group});r=s._getTemplate("footer").render({moreUrl:o.moreUrl,title:s.options.locales["more"]||"more"});e.each(o.docs,function(e,i){if(o.group==="topics"){i.url=foswiki.getScriptUrl("view",i.web,i.topic)}i.phoneNumber=i.field_Telephone_s||i.field_Phone_s||i.field_Mobile_s;i.group=o.group;if(e==0){i.isFirst="ui-autosuggest-first-in-group";i.header=a}else{i.isFirst="";i.header=""}if(e==s.options.extraParams.limit-1||e==n-1){i.isLast="ui-autosuggest-last-in-group";if(n<s.options.extraParams.limit){i.footer=""}else{i.footer=r}}else{i.isLast="";i.footer=""}s._renderItemData(t,i)})})},_renderItem:function(t,i){var s=this,o=s._getTemplate(i.group)||s._getTemplate("default"),a;if(typeof i.thumbnail!=="undefined"){if(!/^(\/|https?:)/.test(i.thumbnail)){i.thumbnail=s.options.thumbnailBase+"&topic="+i.web+"."+i.topic+"&file="+i.thumbnail}}else{i.thumbnail="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="}a=e(o.render(i)).data("ui-autocomplete-item",i);return t.append(a)},_normalize:function(e){return e}})})(jQuery);