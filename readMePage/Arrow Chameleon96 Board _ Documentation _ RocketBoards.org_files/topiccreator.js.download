(function(e){"use strict";function t(t,i){var n=this;n.template="newtopic";n.steps=[{id:".tcTopicTypes",select:".tcTopicType"},{id:".tcTopicTemplates",expand:"topiccreator::topictemplates",select:".tcTopicTemplate"},{id:".tcInputForm",expand:"topiccreator::inputform"}];n.elem=e(t);n.container=n.elem.find(".tcContainer");n.opts=e.extend({topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")},n.elem.data(),i);n.elem.find(".tcNavi").on("click",function(){var t=e(this).attr("href");if(t=="#next"){n.gotoStep(n.currentStep+1,1)}else if(t=="#prev"){n.gotoStep(n.currentStep-1,-1)}else{console.error("unknown target ",t,"clicking on ",this)}return false});n.elem.find(".tcAbort").on("click",function(){e(this).parents(".ui-dialog-content:first").dialog("close");return false});n.elem.find(".tcSubmit").on("click",function(){n.elem.find("form").submit();return false});n.gotoStep(0)}t.prototype.log=function(){var t=this,i=e.makeArray(arguments);i.unshift("TC:");e.log.apply(t,i)};t.prototype.gotoStep=function(t,i){var n=this,o={},s=n.steps[t],r;n.log("called gotoStep",t);if(t<0||t>n.steps.length||typeof s==="undefined"){return}n.currentStep=t;for(r=0;r<t;r++){if(n.steps[r].selectedElem){e.extend(o,n.steps[r].selectedElem.data())}else{n.log("no selected element in step",r)}}if(t==0||i<0){for(r=t;r<n.steps.length;r++){if(n.steps[r].expand){n.log("removing ",n.steps[r].id);n.elem.find(n.steps[r].id).remove();delete n.steps[r].selectedElem}}}if(s.expand&&n.container.find(s.id).length==0){e.extend(o,n.opts,{name:n.template,expand:s.expand,success:function(e){n.container.append(e);n.initStep(t,i)},error:function(e){console.error("Error: "+e.status+" "+e.statusText)}});foswiki.loadTemplate(o)}else{n.initStep(t,i)}};t.prototype.initStep=function(t,i){var n=this,o=n.steps[t],s=n.container.find(o.id);if(n.container.find(o.id).length){n.elem.find(".tcViewPort").scrollTo(o.id,250)}else{return n.gotoStep(n.currentStep+i,i)}if(t==0){n.elem.find(".tcNaviPrev").hide()}else{n.elem.find(".tcNaviPrev").show()}if(t==n.steps.length-1){n.elem.find(".tcNaviNext").hide();n.elem.find(".tcAbort, .tcSubmit").show()}else{n.elem.find(".tcNaviNext").show();n.elem.find(".tcAbort, .tcSubmit").hide()}if(t==2){if(n.steps[1].selectedElem&&n.steps[1].selectedElem.data("topicTemplate")){n.container.find(o.id).find("input[name='templatetopic']").val(n.steps[1].selectedElem.data("topicTemplate"))}}s.find("input[type=text]:first").focus();s.find("input[type=text]:not(.jqTextboxList)").on("keyup",function(e){if(e.keyCode==13){n.elem.find("form").submit();return false}});if(s.data("inited")){n.log("element already inited",o.id);return}s.data("inited",1);n.log("init ",o.id);if(o.select){s.find(o.select).on("click",function(){var t=e(this);s.find(o.select).removeClass("tcSelected");t.addClass("tcSelected");o.selectedElem=t;n.log("selected",t.data());n.gotoStep(n.currentStep+1,1);return false})}s.find("input.tcFilter").on("keyup",function(){var t=e(this).val().toLowerCase();s.find(o.select).each(function(){var i=e(this),n=i.text().toLowerCase();if(n.indexOf(t)>=0){i.show()}else{i.hide()}})})};e.fn.topicCreator=function(i){return this.each(function(){if(!e.data(this,"topicCreator")){e.data(this,"topicCreator",new t(this,i))}})};e(".jqTopicCreator:not(.jqInitedTopicCreator)").livequery(function(){e(this).addClass("jqInitedTopicCreator").topicCreator()})})(jQuery);