jQuery(function(e){e(".foswikiAttachments.foswikiFormSteps:not(.foswikiInitedAttachments)").livequery(function(){var t=e(this),i=e.extend({},t.metadata()),n=foswiki.getPreference("SCRIPTURL")+"/rest/RenderPlugin/template"+"?name=metadata"+";render=on"+";topic="+i.topic,o=t.parent(),a=t.find(".foswikiAttachmentsOptionsToggle"),s=t.find(".foswikiAttachmentsUploadToggle"),f=a.find("span:last"),l=t.find(".foswikiAttachmentsOptionsToggleContainer"),c=t.find(".foswikiAttachmentsUploadToggleContainer"),r=e.extend({},a.metadata()),d=t.find(".foswikiAttachmentsPager");t.addClass(".foswikiInitedAttachments");if(!f.length){f=a}if(typeof i.selection==="undefined"||i.selection==""){i.selection=[]}else{i.selection=i.selection.split(/\s*,\s*/)}if(d.length){i.nrAttachments=t.find(".foswikiAttachmentsPager").metadata().count;t.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text("("+i.nrAttachments+")")}else{i.nrAttachments=0;t.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text("")}function h(){var e=n,a;e+=";expand=attachments";if(typeof i.hidden!=="undefined"){e+=";attachments_hidden="+i.hidden}if(typeof i.sort!=="undefined"){e+=";attachments_sort="+i.sort}if(typeof i.reverse!=="undefined"){e+=";attachments_reverse="+i.reverse}if(typeof i.filter!=="undefined"&&i.filter!=""){e+=";attachments_filter="+encodeURI(i.filter)}if(typeof i.selection!=="undefined"){for(a=0;a<i.selection.length;a++){e+=";attachments_selection="+encodeURI(i.selection[a].replace(/\\\./,"."))}}if(typeof i.limit!=="undefined"){e+=";attachments_limit="+i.limit}if(typeof i.skip!=="undefined"){e+=";attachments_skip="+i.skip}if(typeof i.showOptions!=="undefined"){e+=";attachments_showoptions="+i.showOptions}if(typeof i.showUploader!=="undefined"){e+=";attachments_showuploader="+i.showUploader}if(typeof i.cols!=="undefined"){e+=";attachments_cols="+i.cols}t.block({message:null,fadeIn:0,fadeOut:0,overlayCSS:{cursor:"progress"}});o.load(e,function(){t.unblock();o.height("auto")})}function m(){var n=t.width(),o,a,s,f=t.find(".foswikiAttachment");if(n>1300&&i.nrAttachments>=3){o="foswikiAttachmentsCols3";i.cols=3}else if(n>940&&i.nrAttachments>=2){o="foswikiAttachmentsCols2";i.cols=2}else{o="foswikiAttachmentsCols1";i.cols=1}if(o&&!t.hasClass(o)){t.removeClass("foswikiAttachmentsCols1 foswikiAttachmentsCols2 foswikiAttachmentsCols3");t.addClass(o)}else{}if(i.cols>1){a=0;f.css("height","auto").each(function(){s=e(this).height();if(s>a){a=s}});f.height(a)}else{f.height("auto")}window.setTimeout(function(){e(window).one("resize.attachments",m)},300)}function u(){var n,o;t.find(".foswikiAttachmentSelected").removeClass("foswikiAttachmentSelected");if(i.selection){for(n=0;n<i.selection.length;n++){o=encodeURIComponent(i.selection[n]);e(document.getElementById(o)).addClass("foswikiAttachmentSelected")}if(i.selection.length){t.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").show();t.find(".foswikiAttachmentsSelected").text(i.selection.length)}else{t.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()}}else{t.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()}}function k(e){if(!e){return}if(typeof i.selection==="undefined"){i.selection=[]}i.selection.push(e);if(i.selection.length==i.nrAttachments){t.find(".foswikiAttachmentsSelectAll").hide()}u()}function p(e){if(i.selection){for(var n=0;n<i.selection.length;n++){if(i.selection[n]==e){i.selection.splice(n,1);break}}}t.find(".foswikiAttachmentsSelectAll").show();u()}function w(){i.selection=[];u()}function g(){f.html(r.showText);l.slideUp({easing:"easeInOutQuad",duration:"fast"});i.showOptions="off"}function v(){f.html(r.hideText);l.slideDown({easing:"easeInOutQuad",duration:"fast"});i.showOptions="on"}function A(){c.slideUp({easing:"easeInOutQuad",duration:"fast"});i.showUploader="off"}function C(){c.slideDown({easing:"easeInOutQuad",duration:"fast"});i.showUploader="on";c.find(".jqUploader").trigger("Refresh")}function b(t){var i,n;if(typeof t.id!=="undefined"){i=e(t.id);if(i.length){i.find("form").resetForm();if(typeof t.callback==="function"){t.callback.call(i)}return}}n=e.extend({},t.data,{name:"metadata",expand:t.template,topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")});e.ajax({url:foswiki.getPreference("SCRIPTURL")+"/rest/RenderPlugin/template",data:n,dataType:"html",success:function(i){var n=e(i).appendTo("body");if(typeof t.callback==="function"){window.setTimeout(function(){t.callback.call(n)},100)}}})}m();u();a.click(function(){if(l.is(":visible")){g()}else{v();A()}return false});s.click(function(){if(c.is(":visible")){A()}else{C()}g();return false});if(c.is(":visible")){window.setTimeout(function(){c.find(".jqUploader").trigger("Refresh")},100)}t.find(".foswikiDisplayHidden input").change(function(){i.hidden=e(this).attr("checked")?"on":"off";h();return false});t.find(".foswikiFilter input").bind("keypress",function(t){var n=e(this),o;if(t.keyCode==13){o=n.val();if(o==="none"){o=""}i.filter=o;h();t.preventDefault();return false}});t.find(".foswikiSortBy select").change(function(){var t=e(this);i.sort=t.val();if(i.sort=="date"){i.reverse="on"}else{i.reverse="off"}i.skip=0;h();return false});t.find(".foswikiResultsPerPage select").change(function(){var t=e(this);i.limit=t.val();i.skip=0;h();return false});t.find(".foswikiAttachmentsPager a").click(function(){i=e.extend(i,e(this).metadata());h();return false});t.find(".foswikiAttachment").hover(function(){e(this).addClass("foswikiAttachmentHover")},function(){e(this).removeClass("foswikiAttachmentHover")}).click(function(t){var i=e(this),n=decodeURIComponent(i.attr("id"));if(!e(t.target).is("a")){i.toggleClass("foswikiAttachmentSelected");if(i.hasClass("foswikiAttachmentSelected")){k(n)}else{p(n)}t.stopPropagation();return false}});t.bind("Refresh",function(t,i){if(i){w();e.each(i,function(e,t){k(t.name)})}h();return false});t.find(".foswikiAttachmentsSelectAll").click(function(){i.selection=[];t.find("input.foswikiAttachmentsAll").each(function(){i.selection.push(e(this).val())});e(this).hide();u();return false});t.find(".foswikiAttachmentsClearAll").click(function(){w();t.find(".foswikiAttachmentsSelectAll").show();return false});t.find(".foswikiAttachmentPreviewButton").click(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=e.extend({},i.metadata()),o=n.filename.replace(/^.+\./,""),a;if(o.match(/mp3|wav/)){a="audio"}else if(o.match(/flv|swf|mp4|mpe?g|mov|ogg|webm/)){a="video"}else{a=o}e.blockUI({message:"<h1>Loading preview ...</h1>",fadeIn:0,fadeOut:0});b({template:"attachments::previewer::"+a,data:{filename:n.filename},callback:function(){var t=this;t.dialog("option","open",function(){e.unblockUI();t.parent().find(".ui-dialog-title").text(decodeURIComponent(n.filename))}).dialog("open")}});return false});e("#foswikiAttachmentEditorForm").livequery(function(){var t=e(this);t.ajaxForm({dataType:"json",beforeSubmit:function(){t.parent().dialog("close");e.blockUI({message:"<h1>Saving changes ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,i,n){e.unblockUI();h()},error:function(t,i){var n;try{n=e.parseJSON(t.responseText);i=n.error.message}catch(o){}e.unblockUI();e.pnotify({title:"Edit failed",text:i,type:"error"})}})});t.find(".foswikiAttachmentEditButton").click(function(e){e.stopPropagation()});t.find(".foswikiAttachmentPropertiesButton").click(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=e.extend({},i.metadata()),o=i.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");b({id:"#foswikiAttachmentEditor",template:"attachments::editor",callback:function(){var e=this;e.dialog("option","open",function(){var t=e.find("input[name=hidefile]"),i=e.find("input[name=isthumbnail]");e.find("input[name=origfilename]").val(decodeURIComponent(n.filename));e.find("input[name=filename]").val(decodeURIComponent(n.filename));e.find("input[name=filecomment]").val(decodeURIComponent(n.filecomment));if(o.find(".foswikiAlert").length===0){e.find(".foswikiThumbnailContainer").html(o)}if(n.filename.match(/\.(gif|jpe?g|png|bmp|svg|tiff?)$/i)){e.find(".foswikiThumbnailStep").show()}else{e.find(".foswikiThumbnailStep").hide()}if(n.fileattr.match(/h/)){t.attr("checked","checked")}else{t.removeAttr("checked")}if(n.fileattr.match(/t/)){i.attr("checked","checked")}else{i.removeAttr("checked")}}).dialog("option","position","center").dialog("open")}});return false});e("#foswikiAttachmentConfirmDeleteForm").livequery(function(){var t=e(this),i;t.ajaxForm({dataType:"json",beforeSubmit:function(){t.parent().dialog("close");i=t.find("input[name='filename']").val();e.blockUI({message:"<h1>Deleting "+i+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,n,o){e.unblockUI();p(i);h()},error:function(t,n){var o;try{o=e.parseJSON(t.responseText);n=o.error.message}catch(a){}e.unblockUI();e.pnotify({title:"Failed to delete "+i,text:n,type:"error"})}})});t.find(".foswikiAttachmentDeleteButton").click(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=e.extend({},i.metadata()),o=i.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");b({id:"#foswikiAttachmentConfirmDelete",template:"attachments::confirmdelete",callback:function(){var e=this;e.dialog("option","open",function(){e.find("#deleteAttachment").text(decodeURIComponent(n.filename));e.find("input[name=filename]").val(decodeURIComponent(n.filename));if(o.find(".foswikiAlert").length===0){e.find(".foswikiThumbnailContainer").html(o)}}).dialog("option","position","center").dialog("open")}});return false});e("#foswikiAttachmentMoveForm").livequery(function(){var t=e(this);t.ajaxForm({dataType:"json",beforeSubmit:function(){t.parent().dialog("close");e.blockUI({message:"<h1>Moving attachment(s) ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,i,n){e.unblockUI();w();h()},error:function(t,i){var n;try{n=e.parseJSON(t.responseText);i=n.error.message}catch(o){}e.unblockUI();e.pnotify({title:"Move failed",text:i,type:"error"})}})});t.find(".foswikiAttachmentMoveButton").click(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=e.extend({},i.metadata()),o=i.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");b({id:"#foswikiAttachmentMove",template:"attachments::moveattachment",callback:function(){var e=this;e.dialog("option","open",function(){e.find("input[name=filename]").val(decodeURIComponent(n.filename));if(o.find(".foswikiAlert").length===0){e.find(".foswikiThumbnailContainer").html(o)}e.find(".foswikiGenericThumbnail").hide()}).dialog("open")}});return false});e("#foswikiAttachmentConfirmBulkForm").livequery(function(){var t=e(this),i,n;t.ajaxForm({dataType:"json",beforeSubmit:function(){i=t.find(".foswikiAttachmentBulkMessage:visible .foswikiAttachmentBulkProgressMessage").html();n=t.find("input[name='action']").val();t.parent().dialog("close");e.blockUI({message:"<h1>"+i+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,i,o){e.unblockUI();if(n=="createlink"||n=="createimagegallery"){window.location.href=foswiki.getPreference("SCRIPTURL")+"/view/"+foswiki.getPreference("WEB")+"/"+foswiki.getPreference("TOPIC")}else if(n=="download"){window.location.href=t.result}else if(n=="delete"){w();h()}else{h()}},error:function(t,i){var o;try{o=e.parseJSON(t.responseText);i=o.error.message}catch(a){}e.unblockUI();e.pnotify({title:'Error during "'+n+'"',text:i,type:"error"})}})});t.find(".foswikiAttachmentsBulkAction select").change(function(){var t=e(this),n=t.val(),o,a=i.selection?i.selection.length:0;if(!a||!n){return}t.val("");if(n=="createlink"){o=".foswikiAttachmentBulkCreateLinks"}else if(n=="createimagegallery"){o=".foswikiAttachmentBulkCreateImageGallery"}else if(n=="download"){o=".foswikiAttachmentBulkDownload"}else if(n=="hide"){o=".foswikiAttachmentBulkHide"}else if(n=="unhide"){o=".foswikiAttachmentBulkUnHide"}else if(n=="delete"){o=".foswikiAttachmentBulkDelete"}else if(n=="move"){}else{alert("unknown action "+n);return}if(n!="move"){b({id:"#foswikiAttachmentConfirmBulk",template:"attachments::confirmbulkaction",callback:function(){var t=this;t.dialog("option","open",function(){var s=t.find("form");s.find("input[type='hidden'][name='filename']").remove();e.each(i.selection,function(t,i){e("<input type='hidden' name='filename' />").val(encodeURIComponent(i)).prependTo(s)});t.find("input[name='action']").val(n);s.attr("action",foswiki.getPreference("SCRIPTURL")+"/rest/TopicInteractionPlugin/"+n);t.find(".foswikiAttachmentBulkMessage").hide();t.find(o).show().find("b").text(a)}).dialog("option","position","center").dialog("open")}})}else{b({id:"#foswikiAttachmentMove",template:"attachments::moveattachment",callback:function(){var t=this;t.dialog("option","open",function(){var n=t.find("form");n.find("input[type='hidden'][name='filename']").remove();e.each(i.selection,function(t,i){e("<input type='hidden' name='filename' />").val(encodeURIComponent(i)).prependTo(n)});t.find(".foswikiAttachmentsCount").text(i.selection.length);t.find(".foswikiThumbnailContainer").empty();t.find(".foswikiGenericThumbnail").show()}).dialog("option","position","center").dialog("open")}})}});t.find(".foswikiShowVersions").each(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),o=e.extend({},i.metadata()),a=i.find(".foswikiVersionsContainer"),s=n+";expand=attachments::versions"+";filename="+o.filename;t.click(function(){if(a.is(".foswikiVersionsContainerLoaded")){t.hide();i.find(".foswikiHideVersions").show();a.slideDown("fast",m)}else{a.show();a.load(s,function(){a.addClass("foswikiVersionsContainerLoaded");i.effect("highlight");t.hide();i.find(".foswikiHideVersions").show();m()})}return false})});t.find(".foswikiHideVersions").each(function(){var t=e(this),i=t.parents(".foswikiAttachment:first"),n=i.find(".foswikiVersionsContainer");t.click(function(){t.hide();i.find(".foswikiShowVersions").show();n.slideUp("fast",m);return false})})});e("a[href^='edit://']").livequery(function(){var t=e(this),i=t.attr("href"),n=t.data("version"),o;if(e.browser.msie){t.addClass(".jqWebDAVLink").on("click",function(){i=i.replace(/^edit:/,"https:");o=new ActiveXObject("SharePoint.OpenDocuments.1").EditDocument(i);return false})}})});
