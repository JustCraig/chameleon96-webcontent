(function(e){ChiliBook={version:"2.2",automatic:true,automaticSelector:"code",lineNumbers:!true,codeLanguage:function(r){var n=e(r).attr("class");return n?n:""},recipeLoading:true,recipeFolder:"",replaceSpace:"&#160;",replaceTab:"&#160;&#160;&#160;&#160;",replaceNewLine:"&#160;<br/>",selectionStyle:["position:absolute; z-index:3000; overflow:scroll;","width:16em;","height:9em;","border:1px solid gray;","padding:15px;","background-color:yellow;"].join(" "),defaultReplacement:'<span class="$0">$$</span>',recipes:{},queue:{},unique:function(){return(new Date).valueOf()}};e.fn.chili=function(r){var n=e.extend({},ChiliBook,r||{});function t(r,i,c){function l(e,r){var n=[];for(var t in e[r]){n.push(u(e,r,t))}return n}function u(e,r,t){var i=e[r][t];var a=typeof i._match=="string"?i._match:i._match.source;return{recipe:e,blockName:r,stepName:t,exp:"("+a+")",length:1+(a.replace(/\\./g,"%").replace(/\[.*?\]/g,"%").match(/\((?!\?)/g)||[]).length,replacement:i._replace?i._replace:n.defaultReplacement}}function o(e){var r=1;var n=[];for(var t=0;t<e.length;t++){var a=e[t].exp;a=a.replace(/\\\\|\\(\d+)/g,function(e,n){return!n?e:"\\"+(r+1+parseInt(n,10))});n.push(a);r+=e[t].length}var c="((?:\\s|\\S)*?)";var l="((?:\\s|\\S)+)";var u="(?:"+n.join("|")+")";u=c+u+"|"+l;return new RegExp(u,i._case?"g":"gi")}function p(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;")}function f(e){return e.replace(/ +/g,function(e){return e.replace(/ /g,x)})}function v(e){e=p(e);if(x){e=f(e)}return e}function g(e,r){return t(e,r)}function h(e,r,n){return t(e,r,n)}function d(e,r,t,i){var a=n.replaceSpace;var c=u(r,t,i);var l=[c];var s=e.replace(o(l),function(){return w.apply({steps:l},arguments)});return s}function m(r,t,i){if(!t){return v(r)}var a=t.split("/");var c="";var l="";var u="";switch(a.length){case 1:c=a[0];break;case 2:c=a[0];l=a[1];break;case 3:c=a[0];l=a[1];u=a[2];break;default:return v(r)}function o(e){var r=s(e);var t=n.recipes[r];if(!t){throw{msg:"recipe not available"}}return t}try{var p;if(""==u){if(""==l){if(""==c){}else{p=o(c);return g(r,p)}}else{if(""==c){p=i.recipe}else{p=o(c)}if(!(l in p)){return v(r)}return h(r,p,l)}}else{if(""==c){p=i.recipe}else{p=o(c)}if(""==l){l=i.blockName}if(!(l in p)){return v(r)}if(!(u in p[l])){return v(r)}return d(r,p,l,u)}}catch(f){if(f.msg&&f.msg=="recipe not available"){var b="chili_"+n.unique();if(n.recipeLoading){var w=s(c);if(!n.queue[w]){try{n.queue[w]=[{cue:b,subject:r,module:t,context:i}];e.ajax({url:w,dataType:"text",success:function(r){n.recipes[w]=window.eval("(function() { var recipe = "+r+"; return recipe; }())");var t=n.queue[w];for(var i=0,a=t.length;i<a;i++){var c=m(t[i].subject,t[i].module,t[i].context);if(n.replaceTab){c=c.replace(/\t/g,n.replaceTab)}if(n.replaceNewLine){c=c.replace(/\n/g,n.replaceNewLine)}e("#"+t[i].cue).replaceWith(c)}}})}catch(x){alert("the recipe for '"+c+"' was not found in '"+w+"'")}}else{n.queue[w].push({cue:b,subject:r,module:t,context:i})}return'<span id="'+b+'">'+v(r)+"</span>"}return v(r)}else{return v(r)}}}function b(e,r){var n=r.replace(/(<span\s+class\s*=\s*(["']))((?:(?!__)\w)+\2\s*>)/gi,"$1"+e+"__$3");return n}function w(){if(!arguments[0]){return""}var r=this.steps;var n=0;var t=2;var i=arguments[1];var a=arguments[arguments.length-3];if(!a){var c;while(c=r[n++]){var l=arguments;if(l[t]){var u="";if(e.isFunction(c.replacement)){var s=[];for(var o=0,p=c.length;o<p;o++){s.push(l[t+o])}s.push(l[l.length-2]);s.push(l[l.length-1]);u=c.replacement.apply({x:function(){var e=arguments[0];var r=arguments[1];var n={recipe:c.recipe,blockName:c.blockName};return m(e,r,n)}},s)}else{u=c.replacement.replace(/(\\\$)|(?:\$\$)|(?:\$(\d+))/g,function(e,r,n){if(r){return"$"}else if(!n){return v(l[t])}else if(n=="0"){return c.stepName}else{return v(l[t+parseInt(n,10)])}})}u=b(c.recipe._name,u);return v(i)+u}else{t+=c.length}}}else{return v(a)}}if(!c){c="_main";a(i)}if(!(c in i)){return v(r)}var x=n.replaceSpace;var y=l(i,c);var _=o(y);var S=r.replace(_,function(){return w.apply({steps:y},arguments)});return S}function i(e){if(document.createElement){var r=document.createElement("style");r.type="text/css";if(r.styleSheet){r.styleSheet.cssText=e}else{var n=document.createTextNode(e);r.appendChild(n)}document.getElementsByTagName("head")[0].appendChild(r)}}function a(e){var r=e._name;if(!n.queue[r]){var t=["/* Chili -- "+r+" */"];for(var a in e){if(a.search(/^_(?!main\b)/)<0){for(var c in e[a]){var l=e[a][c];if("_style"in l){if(l["_style"].constructor==String){t.push("."+r+"__"+c+" { "+l["_style"]+" }")}else{for(var u in l["_style"]){t.push("."+r+"__"+u+" { "+l["_style"][u]+" }")}}}}}}t=t.join("\n");i(t);n.queue[r]=true}}function c(r){var t=n.codeLanguage(r);if(""!=t){var i=s(t);if(n.recipeLoading){if(!n.queue[i]){try{n.queue[i]=[r];e.ajax({url:i,dataType:"text",success:function(e){n.recipes[i]=window.eval("(function() { var recipe = "+e+"; return recipe; }())");var r=n.queue[i];for(var t=0,a=r.length;t<a;t++){l(r[t],i)}}})}catch(a){alert("the recipe for '"+t+"' was not found in '"+i+"'")}}else{n.queue[i].push(r)}l(r,i)}else{l(r,i)}}}function l(r,i){var a=n.recipes[i];if(!a){return}var c=e(r);var l=c.text();if(!l){return}l=l.replace(/\r\n?/g,"\n");if(c.parent().is("pre")){if(!e.browser.safari){l=l.replace(/^\n/g,"")}}var s=t(l,a);if(n.replaceTab){s=s.replace(/\t/g,n.replaceTab)}if(n.replaceNewLine){s=s.replace(/\n/g,n.replaceNewLine)}r.innerHTML=s;if(e.browser.msie||e.browser.mozilla){u(r)}var o=c.parent();var p=o.attr("class");var v=/ln-(\d+)-([\w][\w\-]*)|ln-(\d+)|ln-/.exec(p);if(v){f(r);var g=0;if(v[1]){g=parseInt(v[1],10);var h=e(".ln-"+v[1]+"-"+v[2]);var d=h.index(o[0]);h.slice(0,d).each(function(){g+=e(this).find("li").length})}else if(v[3]){g=parseInt(v[3],10)}else{g=1}c.find("ol")[0].start=g;e("body").width(e("body").width()-1).width(e("body").width()+1)}else if(n.lineNumbers){f(r)}}function u(r){var n=null;e(r).parents().filter("pre").bind("mousedown",function(){n=this;if(e.browser.msie){document.selection.empty()}else{window.getSelection().removeAllRanges()}}).bind("mouseup",function(r){if(n&&n==this){n=null;var t="";if(e.browser.msie){t=document.selection.createRange().htmlText;if(""==t){return}t=p(t);var i='<textarea style="STYLE">'}else{t=window.getSelection().toString();if(""==t){return}t=t.replace(/\r/g,"").replace(/^# ?/g,"").replace(/\n# ?/g,"\n");var i='<pre style="STYLE">'}var a=e(i.replace(/\bSTYLE\b/,ChiliBook.selectionStyle)).appendTo("body").text(t).attr("id","chili_selection").click(function(){e(this).remove()});var c=r.pageY-Math.round(a.height()/2)+"px";var l=r.pageX-Math.round(a.width()/2)+"px";a.css({top:c,left:l});if(e.browser.msie){a[0].focus();a[0].select()}else{var u=window.getSelection();u.removeAllRanges();var s=document.createRange();s.selectNodeContents(a[0]);u.addRange(s)}}})}function s(e){return n.recipeFolder+e+".js"}function o(){var r="";if(e.browser.msie){r=document.selection.createRange().htmlText}else{r=window.getSelection().toString()}return r}function p(r){do{var n=ChiliBook.unique()}while(r.indexOf(n)>-1);var t="";if(/<br/i.test(r)||/<li/i.test(r)){if(/<br/i.test(r)){r=r.replace(/\<br[^>]*?\>/gi,n)}else if(/<li/i.test(r)){r=r.replace(/<ol[^>]*?>|<\/ol>|<li[^>]*?>/gi,"").replace(/<\/li>/gi,n)}var i=e("<pre>").appendTo("body").hide()[0];i.innerHTML=r;t=e(i).text().replace(new RegExp(n,"g"),"\r\n");e(i).remove()}return t}function f(r){function t(e,r,n,t){var i=t?"</span>":"";var a="";if(e){a="<li>"+t+r+i+"</li>"}else if(n){a="<li>"+t+n+i+"</li>"}return a}function i(e,r,n,i){var a="";if(i){a=i}else{a=t(e,r,n,"")}return a}var a=e(r).html();var c=/<br>/.test(a)?"<br>":"<BR>";var l="<li>"+n.replaceSpace+"</li>";var u=a.replace(/(<span [^>]+>)((?:(?:&nbsp;|\xA0)<br>)+)(.*?)(<\/span>)/gi,"$2$1$3$4").replace(/(.*?)(<span .*?>)(.*?)(?:<\/span>(?:&nbsp;|\xA0)<br>|<\/span>)/gi,function(e,r,n,i){if(/<br>/i.test(i)){var a=r.split(c);var l=a.pop();r=a.join(c);var u=(r?r+c:"")+(l+i).replace(/((.*?)(?:&nbsp;|\xA0)<br>)|(.*)/gi,function(e,r,i,a){var c=t(r,i,a,n);return c});return u}else{return e}}).replace(/(<li>.*?<\/li>)|((.*?)(?:&nbsp;|\xA0)<br>)|(.+)/gi,function(e,r,n,t,a){var c=i(n,t,a,r);return c}).replace(/<li><\/li>/gi,l);r.innerHTML="<ol>"+u+"</ol>"}function v(r){return e.map(r.split(""),function(e,r){return" "+e+" "+e.charCodeAt(0)+" "}).join(" ")}this.each(function(){var r=e(this);r.trigger("chili.before_coloring");c(this);r.trigger("chili.after_coloring")});return this}})(jQuery);