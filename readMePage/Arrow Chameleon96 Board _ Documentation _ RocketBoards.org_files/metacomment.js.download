jQuery(function(e){var t=false;e(".cmtComments:not(.cmtCommentsInited)").livequery(function(){var n=e(this),o=n.parent(),r={topic:foswiki.getPreference("TOPIC"),web:foswiki.getPreference("WEB")},i=e.extend({},r,n.metadata()),m;function a(n){if(!t){t=true;e.get(foswiki.getPreference("SCRIPTURL")+"/rest/RenderPlugin/template",{name:"metacomments",render:"on",topic:i.web+"."+i.topic,expand:"comments::dialogs"},function(t,o,r){e("body").append(t);window.setTimeout(n,100)})}else{e(".cmtDialog form").resetForm();n.call()}}function c(t){var n=foswiki.getPreference("SCRIPTURL")+"/rest/RenderPlugin/template"+"?name=metacomments"+";render=on"+";topic="+i.web+"."+i.topic+";expand=metacomments";o.load(n,function(){e.unblockUI();o.height("auto")})}n.find(".cmtComment").hover(function(){var t=e(this),n=t.children(".cmtControls");t.addClass("cmtHover");n.stop(true,true).fadeIn(500)},function(){var t=e(this),n=t.children(".cmtControls");n.stop(true,true).hide();t.removeClass("cmtHover")});e(".cmtAddCommentForm, .cmtReplyCommentForm").livequery(function(){var t=e(this),n;t.ajaxForm({dataType:"json",beforeSubmit:function(){n=t.find("input[name='ref']").val();e("#cmtReplyComment").dialog("close");e.blockUI({message:"<h1>Submitting comment ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,n,o){if(t.error){e.unblockUI();e.pnotify({text:"Error: "+t.error.message,type:"error"})}else{c()}},error:function(t,n){var o=e.parseJSON(t.responseText);e.unblockUI();e.pnotify({text:"Error: "+o.error.message,type:"error"})}})});e(".cmtUpdateCommentForm").livequery(function(){var t=e(this),o,r,i;t.ajaxForm({dataType:"json",beforeSubmit:function(){r=t.find("input[name='comment_id']").val();i=t.find("input[name='index']").val();o=n.find("#comment"+r.replace(/\./g,"\\\\.")).parent();e("#cmtUpdateComment").dialog("close");e.blockUI({message:"<h1>Updating comment "+i+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,n,o){if(t.error){e.unblockUI();e.pnotify({text:"Error: "+t.error.message,type:"error"})}else{c()}},error:function(t,n){var o=e.parseJSON(t.responseText);e.unblockUI();e.pnotify({text:"Error: "+o.error.message,type:"error"})}})});e(".cmtConfirmDeleteForm").livequery(function(){var t=e(this),o,r,i;t.ajaxForm({beforeSubmit:function(){r=t.find("input[name='comment_id']").val().replace(/\./g,"\\\\.");i=t.find("input[name='index']").val();o=n.find("#comment"+r).parent();e("#cmtConfirmDelete").dialog("close");e.blockUI({message:"<h1>Deleting comment "+i+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,n,o){if(t.error){e.unblockUI();e.pnotify({text:"Error: "+t.error.message,type:"error"})}else{c()}},error:function(t,n){var o=e.parseJSON(t.responseText);e.unblockUI();e.pnotify({text:"Error: "+o.error.message,type:"error"})}})});e(".cmtConfirmApproveForm").livequery(function(){var t=e(this),o,r,i;t.ajaxForm({beforeSubmit:function(){r=t.find("input[name='comment_id']").val();i=t.find("input[name='index']").val();o=n.find("#comment"+r.replace(/\./g,"\\\\.")).parent();e("#cmtConfirmApprove").dialog("close");e.blockUI({message:"<h1>Approving comment "+i+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t,n,o){if(t.error){e.unblockUI();e.pnotify({text:"Error: "+t.error.message,type:"error"})}else{c()}},error:function(t,n){var o=e.parseJSON(t.responseText);e.unblockUI();e.pnotify({text:"Error: "+o.error.message,type:"error"})}})});n.find(".cmtReply").click(function(){var t=e(this).parents(".cmtComment:first"),n=e.extend({},t.metadata());a(function(){e("#cmtReplyComment").dialog("option","open",function(){var t=e(this);t.find(".cmtCommentIndex").text(n.index);t.find("input[name='ref']").val(n.comment_id)}).dialog("open")});return false});n.find(".cmtEdit").click(function(){var t=e(this).parents(".cmtComment:first"),n=e.extend({},t.metadata());a(function(){e.jsonRpc(foswiki.getPreference("SCRIPTURL")+"/jsonrpc",{namespace:"MetaCommentPlugin",method:"getComment",params:{topic:i.web+"."+i.topic,comment_id:n.comment_id},success:function(t,o,r){e.unblockUI();e("#cmtUpdateComment").dialog("option","open",function(){var o=e(this);o.find("input[name='comment_id']").val(n.comment_id);o.find("input[name='index']").val(n.index);o.find(".cmtCommentIndex").text(n.index);o.find("input[name='title']").val(t.result.title);o.find("textarea[name='text']").val(t.result.text)}).dialog("open")},error:function(t,n,o){e.unblockUI();e.pnotify({text:"Error: "+t.error.message,type:"error"})}})});return false});n.find(".cmtDelete").click(function(){var t=e(this).parents(".cmtComment:first"),n=e.extend({},t.metadata());a(function(){e("#cmtConfirmDelete").dialog("option","open",function(){var t=e(this);t.find("input[name='comment_id']").val(n.comment_id);t.find("input[name='index']").val(n.index);t.find(".cmtCommentNr").text(n.index);t.find(".cmtAuthor").text(n.author);t.find(".cmtDate").text(n.date)}).dialog("open")});return false});n.find(".cmtApprove").click(function(){var t=e(this).parents(".cmtComment:first"),n=e.extend({},t.metadata());a(function(){e("#cmtConfirmApprove").dialog("option","open",function(){var t=e(this);t.find("input[name='comment_id']").val(n.comment_id);t.find("input[name='index']").val(n.index);t.find(".cmtCommentNr").text(n.index);t.find(".cmtAuthor").text(n.author);t.find(".cmtDate").text(n.date)}).dialog("open")});return false});m=window.location.hash;if(m.match(/^#comment\d\.\d+$/)){window.location.hash="";window.location.hash=m}window.setTimeout(function(){n.find(".twistyPlugin").show()},1)})});
